<!DOCTYPE html><html lang="en"><head><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin /><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><link rel="icon" type="image/png" href="/favicons/woman-technologist.png"/><link rel="manifest" href="/favicons/site.webmanifest"/><link rel="mask-icon" href="/favicons/safari-pinned-tab.svg" color="#000000"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.3.1/styles/default.min.css"/><script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.3.1/highlight.min.js"></script><script>hljs.highlightAll();</script><link rel="shortcut icon" href="/favicons/woman-technologist.png"/><meta name="msapplication-TileColor" content="#000000"/><meta name="msapplication-config" content="/favicons/browserconfig.xml"/><meta name="theme-color" content="#000"/><link rel="alternate" type="application/rss+xml" href="/feed.xml"/><meta name="description" content="Patience Shyu, Senior Software Engineer"/><meta property="og:image" content="https://og-image.vercel.app/Next.js%20Blog%20Starter%20Example.png?theme=light&amp;md=1&amp;fontSize=100px&amp;images=https%3A%2F%2Fassets.vercel.com%2Fimage%2Fupload%2Ffront%2Fassets%2Fdesign%2Fnextjs-black-logo.svg"/><script data-goatcounter="https://patiences.goatcounter.com/count" async="" src="//gc.zgo.at/count.js"></script><title>TIL: Postgres can halt write activity</title><meta name="next-head-count" content="18"/><link rel="preload" href="/_next/static/css/e6dea86d5ceaa009.css" as="style"/><link rel="stylesheet" href="/_next/static/css/e6dea86d5ceaa009.css" data-n-g=""/><link rel="preload" href="/_next/static/css/e1f6961df2961232.css" as="style"/><link rel="stylesheet" href="/_next/static/css/e1f6961df2961232.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-514908bffb652963.js" defer=""></script><script src="/_next/static/chunks/framework-91d7f78b5b4003c8.js" defer=""></script><script src="/_next/static/chunks/main-eab312c0bf2a7270.js" defer=""></script><script src="/_next/static/chunks/pages/_app-90e414d931afb8eb.js" defer=""></script><script src="/_next/static/chunks/621-61fd141301762a3d.js" defer=""></script><script src="/_next/static/chunks/672-76c886ad533112eb.js" defer=""></script><script src="/_next/static/chunks/pages/writing/%5Bslug%5D-13abfa1974d18446.js" defer=""></script><script src="/_next/static/kDe1iubExyAWuXQplVtme/_buildManifest.js" defer=""></script><script src="/_next/static/kDe1iubExyAWuXQplVtme/_ssgManifest.js" defer=""></script><script src="/_next/static/kDe1iubExyAWuXQplVtme/_middlewareManifest.js" defer=""></script><style data-href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@100;400&display=swap">@font-face{font-family:'IBM Plex Mono';font-style:normal;font-weight:100;font-display:swap;src:url(https://fonts.gstatic.com/s/ibmplexmono/v19/-F6pfjptAgt5VM-kVkqdyU8n3kwq0Q.woff) format('woff')}@font-face{font-family:'IBM Plex Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/ibmplexmono/v19/-F63fjptAgt5VM-kVkqdyU8n5is.woff) format('woff')}@font-face{font-family:'IBM Plex Mono';font-style:normal;font-weight:100;font-display:swap;src:url(https://fonts.gstatic.com/s/ibmplexmono/v19/-F6pfjptAgt5VM-kVkqdyU8n3kwa2HdgregdFOFh.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C8A,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'IBM Plex Mono';font-style:normal;font-weight:100;font-display:swap;src:url(https://fonts.gstatic.com/s/ibmplexmono/v19/-F6pfjptAgt5VM-kVkqdyU8n3kwa0XdgregdFOFh.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'IBM Plex Mono';font-style:normal;font-weight:100;font-display:swap;src:url(https://fonts.gstatic.com/s/ibmplexmono/v19/-F6pfjptAgt5VM-kVkqdyU8n3kwa2ndgregdFOFh.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB}@font-face{font-family:'IBM Plex Mono';font-style:normal;font-weight:100;font-display:swap;src:url(https://fonts.gstatic.com/s/ibmplexmono/v19/-F6pfjptAgt5VM-kVkqdyU8n3kwa23dgregdFOFh.woff2) format('woff2');unicode-range:U+0100-02BA,U+02BD-02C5,U+02C7-02CC,U+02CE-02D7,U+02DD-02FF,U+0304,U+0308,U+0329,U+1D00-1DBF,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20C0,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'IBM Plex Mono';font-style:normal;font-weight:100;font-display:swap;src:url(https://fonts.gstatic.com/s/ibmplexmono/v19/-F6pfjptAgt5VM-kVkqdyU8n3kwa1XdgregdFA.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'IBM Plex Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/ibmplexmono/v19/-F63fjptAgt5VM-kVkqdyU8n1iIq131nj-otFQ.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C8A,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'IBM Plex Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/ibmplexmono/v19/-F63fjptAgt5VM-kVkqdyU8n1isq131nj-otFQ.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'IBM Plex Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/ibmplexmono/v19/-F63fjptAgt5VM-kVkqdyU8n1iAq131nj-otFQ.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB}@font-face{font-family:'IBM Plex Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/ibmplexmono/v19/-F63fjptAgt5VM-kVkqdyU8n1iEq131nj-otFQ.woff2) format('woff2');unicode-range:U+0100-02BA,U+02BD-02C5,U+02C7-02CC,U+02CE-02D7,U+02DD-02FF,U+0304,U+0308,U+0329,U+1D00-1DBF,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20C0,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'IBM Plex Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/ibmplexmono/v19/-F63fjptAgt5VM-kVkqdyU8n1i8q131nj-o.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}</style></head><body><div id="__next" data-reactroot=""><div class="intro"><main><div class="container mx-auto w-11/12 sm:w-5/6 intro-card jumbotron"><section class="flex-col md:flex-row items-center"><h1 class="text-7xl md:text-8xl tracking-tighter leading-tight hello">hi, i&#x27;m patience!</h1><div class="links md:text-3xl flex flex-wrap"><a class="pr-8" href="/">home</a><a class="pr-8 active" href="/writing">writing</a><a class="pr-8" href="http://github.com/patiences">github</a><a class="pr-8" href="http://linkedin.com/in/patienceshyu">linkedin</a><a class="pr-8" href="mailto:patienceshyu@gmail.com">email</a></div></section><article class="mb-32"><div class="mb-4 text-lg text-slate-700 post-content"><time dateTime="2025-05-21T00:00:00+02:00">May	20, 2025</time></div><h1 class="post-title text-4xl sm:text-4xl md:text-6xl lg:text-7xl tracking-tighter leading-tight md:leading-none mb-6 text-center md:text-left">TIL: Postgres can halt write activity</h1><div class="mb-12"><p class="py-2 px-4 text-xs sm:text-base inline-block rounded-full font-extrabold bg-[#FE6A6A]/75 mr-2 mb-2 text-white post-content">postgres</p><p class="py-2 px-4 text-xs sm:text-base inline-block rounded-full font-extrabold bg-[#FE6A6A]/75 mr-2 mb-2 text-white post-content">databases</p></div><div class=" mx-auto post-content"><div class="markdown-styles_markdown__h_8de"><p>Postgres databases can receive so much write activity that they just stop accepting new commands.</p>
<pre><code>ERROR: database is not accepting commands to avoid wraparound data loss in database “postgres”

</code></pre>
<h2>Why does this happen?</h2>
<h3>Transaction IDs (XID)</h3>
<p>When a transaction first writes to a database (i.e. with an <code>INSERT</code>, <code>UPDATE</code> or <code>DELETE</code> statement), the row version that is created is assigned a unique transaction identifier (also called XID). This XID is a 32 bit integer, which means that there is a limit to the number of possible values (~4 billion total, ranging from -2 billion-ish to +2 billion-ish).</p>
<h3>Why are XIDs needed?</h3>
<p>To allow concurrent access to data (e.g. reads not blocking writes), Postgres uses Multiversion Concurrency Control (MVCC) to ensure that each SQL statement sees the correct version of the data.</p>
<p>As soon as a transaction starts writing to the database, an XID is assigned to that transaction from the global counter, and each row that is inserted also has the XID saved in it. That way, only transactions with a “later” XID will be able to see this row once this transaction has committed.</p>
<h3>XID Wraparound</h3>
<p>Since there there is a limit to the number of available XIDs, once we hit the maximum integer value, we need to wrap around to the minimum integer value. This is implemented in Postgres using modulo 2^32 arithmetic. So as long as there are always “future” XIDs available for incoming transactions, everything’s fine.</p>
<h3>Vacuuming</h3>
<p>The mechanism that enables reuse of XIDs is called vacuuming. It’s a SQL command (<code>VACUUM</code>) that performs garbage collection, which marks rows as <code>frozen</code> once the transaction that inserted that row has been completed, so that row version’s XID can now be returned to be reused.</p>
<p>Postgres provides an autovacuum option, which automates the execution of <code>VACUUM</code> commands. However, <code>VACUUM</code> creates a significant amount of I/O traffic, which can negatively impact performance of other active sessions on the database. This is where configuration of the autovacuum to run less frequently can be done to minimize that impact.</p>
<h3>The Problem</h3>
<p>However, this is where our original problem can occur: you can run out of XIDs if you don’t vacuum enough on a database that receives enough write activity. This can be exacerbated by very long running transactions, or sessions holding on to locks for a very long time as the backlog of transactions to execute fills up.</p>
<p>Postgres stops accepting write commands once there are &#x3C; 1 million XIDs left, which leaves the database in a read-only state while the vacuums finish.</p>
<h3>Sources</h3>
<p><a href="https://www.postgresql.org/docs/current/transaction-id.html">Postgres documentation on transactions</a><br>
<a href="https://www.postgresql.org/docs/current/routine-vacuuming.html#ROUTINE-VACUUMING">Postgres documentation on vacuuming</a><br>
<a href="https://blog.sentry.io/transaction-id-wraparound-in-postgres/">Incident report from 2015 from Sentry</a><br>
<a href="https://devcenter.heroku.com/articles/postgresql-concurrency">Article on Postgres &#x26; MVCC from Heroku</a></p>
</div></div></article></div></main></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"TIL: Postgres can halt write activity","date":"2025-05-21T00:00:00+02:00","tags":["postgres","databases"],"slug":"til-postgres-can-halt-write-activity","content":"\u003cp\u003ePostgres databases can receive so much write activity that they just stop accepting new commands.\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eERROR: database is not accepting commands to avoid wraparound data loss in database “postgres”\n\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003eWhy does this happen?\u003c/h2\u003e\n\u003ch3\u003eTransaction IDs (XID)\u003c/h3\u003e\n\u003cp\u003eWhen a transaction first writes to a database (i.e. with an \u003ccode\u003eINSERT\u003c/code\u003e, \u003ccode\u003eUPDATE\u003c/code\u003e or \u003ccode\u003eDELETE\u003c/code\u003e statement), the row version that is created is assigned a unique transaction identifier (also called XID). This XID is a 32 bit integer, which means that there is a limit to the number of possible values (~4 billion total, ranging from -2 billion-ish to +2 billion-ish).\u003c/p\u003e\n\u003ch3\u003eWhy are XIDs needed?\u003c/h3\u003e\n\u003cp\u003eTo allow concurrent access to data (e.g. reads not blocking writes), Postgres uses Multiversion Concurrency Control (MVCC) to ensure that each SQL statement sees the correct version of the data.\u003c/p\u003e\n\u003cp\u003eAs soon as a transaction starts writing to the database, an XID is assigned to that transaction from the global counter, and each row that is inserted also has the XID saved in it. That way, only transactions with a “later” XID will be able to see this row once this transaction has committed.\u003c/p\u003e\n\u003ch3\u003eXID Wraparound\u003c/h3\u003e\n\u003cp\u003eSince there there is a limit to the number of available XIDs, once we hit the maximum integer value, we need to wrap around to the minimum integer value. This is implemented in Postgres using modulo 2^32 arithmetic. So as long as there are always “future” XIDs available for incoming transactions, everything’s fine.\u003c/p\u003e\n\u003ch3\u003eVacuuming\u003c/h3\u003e\n\u003cp\u003eThe mechanism that enables reuse of XIDs is called vacuuming. It’s a SQL command (\u003ccode\u003eVACUUM\u003c/code\u003e) that performs garbage collection, which marks rows as \u003ccode\u003efrozen\u003c/code\u003e once the transaction that inserted that row has been completed, so that row version’s XID can now be returned to be reused.\u003c/p\u003e\n\u003cp\u003ePostgres provides an autovacuum option, which automates the execution of \u003ccode\u003eVACUUM\u003c/code\u003e commands. However, \u003ccode\u003eVACUUM\u003c/code\u003e creates a significant amount of I/O traffic, which can negatively impact performance of other active sessions on the database. This is where configuration of the autovacuum to run less frequently can be done to minimize that impact.\u003c/p\u003e\n\u003ch3\u003eThe Problem\u003c/h3\u003e\n\u003cp\u003eHowever, this is where our original problem can occur: you can run out of XIDs if you don’t vacuum enough on a database that receives enough write activity. This can be exacerbated by very long running transactions, or sessions holding on to locks for a very long time as the backlog of transactions to execute fills up.\u003c/p\u003e\n\u003cp\u003ePostgres stops accepting write commands once there are \u0026#x3C; 1 million XIDs left, which leaves the database in a read-only state while the vacuums finish.\u003c/p\u003e\n\u003ch3\u003eSources\u003c/h3\u003e\n\u003cp\u003e\u003ca href=\"https://www.postgresql.org/docs/current/transaction-id.html\"\u003ePostgres documentation on transactions\u003c/a\u003e\u003cbr\u003e\n\u003ca href=\"https://www.postgresql.org/docs/current/routine-vacuuming.html#ROUTINE-VACUUMING\"\u003ePostgres documentation on vacuuming\u003c/a\u003e\u003cbr\u003e\n\u003ca href=\"https://blog.sentry.io/transaction-id-wraparound-in-postgres/\"\u003eIncident report from 2015 from Sentry\u003c/a\u003e\u003cbr\u003e\n\u003ca href=\"https://devcenter.heroku.com/articles/postgresql-concurrency\"\u003eArticle on Postgres \u0026#x26; MVCC from Heroku\u003c/a\u003e\u003c/p\u003e\n"}},"__N_SSG":true},"page":"/writing/[slug]","query":{"slug":"til-postgres-can-halt-write-activity"},"buildId":"kDe1iubExyAWuXQplVtme","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>