<!DOCTYPE html><html lang="en"><head><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin /><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><link rel="icon" type="image/png" href="/favicons/woman-technologist.png"/><link rel="manifest" href="/favicons/site.webmanifest"/><link rel="mask-icon" href="/favicons/safari-pinned-tab.svg" color="#000000"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.3.1/styles/default.min.css"/><script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.3.1/highlight.min.js"></script><script>hljs.highlightAll();</script><link rel="shortcut icon" href="/favicons/woman-technologist.png"/><meta name="msapplication-TileColor" content="#000000"/><meta name="msapplication-config" content="/favicons/browserconfig.xml"/><meta name="theme-color" content="#000"/><link rel="alternate" type="application/rss+xml" href="/feed.xml"/><meta name="description" content="Patience Shyu, Senior Software Engineer"/><meta property="og:image" content="https://og-image.vercel.app/Next.js%20Blog%20Starter%20Example.png?theme=light&amp;md=1&amp;fontSize=100px&amp;images=https%3A%2F%2Fassets.vercel.com%2Fimage%2Fupload%2Ffront%2Fassets%2Fdesign%2Fnextjs-black-logo.svg"/><script data-goatcounter="https://patiences.goatcounter.com/count" async="" src="//gc.zgo.at/count.js"></script><title>VOC Optimization - Primitive Object Preallocation (Google Summer of Code)</title><meta name="next-head-count" content="18"/><link rel="preload" href="/_next/static/css/e6dea86d5ceaa009.css" as="style"/><link rel="stylesheet" href="/_next/static/css/e6dea86d5ceaa009.css" data-n-g=""/><link rel="preload" href="/_next/static/css/e1f6961df2961232.css" as="style"/><link rel="stylesheet" href="/_next/static/css/e1f6961df2961232.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-514908bffb652963.js" defer=""></script><script src="/_next/static/chunks/framework-91d7f78b5b4003c8.js" defer=""></script><script src="/_next/static/chunks/main-eab312c0bf2a7270.js" defer=""></script><script src="/_next/static/chunks/pages/_app-90e414d931afb8eb.js" defer=""></script><script src="/_next/static/chunks/621-61fd141301762a3d.js" defer=""></script><script src="/_next/static/chunks/672-76c886ad533112eb.js" defer=""></script><script src="/_next/static/chunks/pages/writing/%5Bslug%5D-ffac89d747081253.js" defer=""></script><script src="/_next/static/4r6jreuI5vp9F2TbxVft0/_buildManifest.js" defer=""></script><script src="/_next/static/4r6jreuI5vp9F2TbxVft0/_ssgManifest.js" defer=""></script><script src="/_next/static/4r6jreuI5vp9F2TbxVft0/_middlewareManifest.js" defer=""></script><style data-href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@100;400&display=swap">@font-face{font-family:'IBM Plex Mono';font-style:normal;font-weight:100;font-display:swap;src:url(https://fonts.gstatic.com/s/ibmplexmono/v12/-F6pfjptAgt5VM-kVkqdyU8n3kwq0Q.woff) format('woff')}@font-face{font-family:'IBM Plex Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/ibmplexmono/v12/-F63fjptAgt5VM-kVkqdyU8n5is.woff) format('woff')}@font-face{font-family:'IBM Plex Mono';font-style:normal;font-weight:100;font-display:swap;src:url(https://fonts.gstatic.com/s/ibmplexmono/v12/-F6pfjptAgt5VM-kVkqdyU8n3kwa2HdgregdFOFh.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'IBM Plex Mono';font-style:normal;font-weight:100;font-display:swap;src:url(https://fonts.gstatic.com/s/ibmplexmono/v12/-F6pfjptAgt5VM-kVkqdyU8n3kwa0XdgregdFOFh.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'IBM Plex Mono';font-style:normal;font-weight:100;font-display:swap;src:url(https://fonts.gstatic.com/s/ibmplexmono/v12/-F6pfjptAgt5VM-kVkqdyU8n3kwa2ndgregdFOFh.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+1EA0-1EF9,U+20AB}@font-face{font-family:'IBM Plex Mono';font-style:normal;font-weight:100;font-display:swap;src:url(https://fonts.gstatic.com/s/ibmplexmono/v12/-F6pfjptAgt5VM-kVkqdyU8n3kwa23dgregdFOFh.woff2) format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'IBM Plex Mono';font-style:normal;font-weight:100;font-display:swap;src:url(https://fonts.gstatic.com/s/ibmplexmono/v12/-F6pfjptAgt5VM-kVkqdyU8n3kwa1XdgregdFA.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'IBM Plex Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/ibmplexmono/v12/-F63fjptAgt5VM-kVkqdyU8n1iIq131nj-otFQ.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'IBM Plex Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/ibmplexmono/v12/-F63fjptAgt5VM-kVkqdyU8n1isq131nj-otFQ.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'IBM Plex Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/ibmplexmono/v12/-F63fjptAgt5VM-kVkqdyU8n1iAq131nj-otFQ.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+1EA0-1EF9,U+20AB}@font-face{font-family:'IBM Plex Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/ibmplexmono/v12/-F63fjptAgt5VM-kVkqdyU8n1iEq131nj-otFQ.woff2) format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'IBM Plex Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/ibmplexmono/v12/-F63fjptAgt5VM-kVkqdyU8n1i8q131nj-o.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}</style></head><body><div id="__next" data-reactroot=""><div class="intro"><main><div class="container mx-auto w-11/12 sm:w-5/6 intro-card jumbotron"><section class="flex-col md:flex-row items-center"><h1 class="text-7xl md:text-8xl tracking-tighter leading-tight hello">hi, i&#x27;m patience!</h1><div class="links md:text-3xl flex flex-wrap"><a class="pr-8" href="/">home</a><a class="pr-8 active" href="/writing">writing</a><a class="pr-8" href="http://github.com/patiences">github</a><a class="pr-8" href="http://linkedin.com/in/patienceshyu">linkedin</a><a class="pr-8" href="https://medium.com/@patiences">medium</a><a class="pr-8" href="https://twitter.com/patienceshyu">twitter</a><a class="pr-8" href="mailto:patienceshyu@gmail.com">email</a></div></section><article class="mb-32"><div class="mb-4 text-lg text-slate-700 post-content"><time dateTime="2018-06-19T00:30:00.322Z">June	19, 2018</time></div><h1 class="post-title text-4xl sm:text-4xl md:text-6xl lg:text-7xl tracking-tighter leading-tight md:leading-none mb-6 text-center md:text-left">VOC Optimization - Primitive Object Preallocation (Google Summer of Code)</h1><div class="mb-12"><p class="py-2 px-4 text-xs sm:text-base inline-block rounded-full font-extrabold bg-[#FE6A6A]/75 mr-2 mb-2 text-white post-content">python</p><p class="py-2 px-4 text-xs sm:text-base inline-block rounded-full font-extrabold bg-[#FE6A6A]/75 mr-2 mb-2 text-white post-content">performance optimization</p><p class="py-2 px-4 text-xs sm:text-base inline-block rounded-full font-extrabold bg-[#FE6A6A]/75 mr-2 mb-2 text-white post-content">open source</p></div><div class=" mx-auto post-content"><div class="markdown-styles_markdown__h_8de"><p>I’m about a month into my <a href="https://summerofcode.withgoogle.com/">Google Summer of Code</a> project with <a href="https://pybee.org/">BeeWare</a>, and it’s high time I wrote about the specific library I'm working on and what I’ve been up to.</p>
<h2>About VOC</h2>
<p><a href="https://pybee.org/project/projects/bridges/voc/">VOC</a> is a library that compiles Python code into Java bytecode.
It fits into BeeWare’s overarching goal of enabling mobile development in Python because it allows you to run your Python source code on the JVM, and write Python code that interacts with native Android APIs. Essentially, Python source files are parsed into abstract syntax trees and converted into JVM bytecode instructions. Python types and the standard library are implemented in Java (though no Java file is ever created).
The result is a bunch of Java class files that can be executed in the JVM.</p>
<h2>My Project</h2>
<p>My project goal is to significantly improve the runtime of VOC-generated bytecode. VOC is a fairly naive compiler,
and no significant efforts have been made (until now!) to optimize performance, which is good for me because there
are some pretty low-cost things we can do for a major boost.
Find my initial project proposal<a href="https://github.com/pybee/voc/issues/772%22">here</a> (though it became outdated about a week into the work).</p>
<h2>Object Creation is Expensive</h2>
<p>Everything in Python is an Object. This means that even small programs can create tons of Objects, including integers, booleans, and strings. Creating an integer, for example, looks like this in bytecode:</p>
<pre><code>NEW org/python/types/Int
DUP
LDC2_W (Long 42)
INVOKESPECIAL org/python/types/Int.init (J)V
</code></pre>
<p>Luckily we can exploit the fact that integers and booleans are immutable objects. Strings are immutable as well, but
it’s hard to tell which strings are used often enough that they should be cached. Integers, on the other hand, especially
small integers, are used all the time. This optimization idea comes from
<a href="https://github.com/python/cpython/blob/master/Objects/longobject.c#L43">CPython</a>, where integers -5 to 256
inclusive are pre-allocated, shared and created only once. That’s exactly what we did in VOC, by making the Int constructor
private and checking if we can use a pre-allocated Int before calling the constructor.</p>
<p>So on the bytecode side, we can replace a constructor call with a static method call which is much cheaper:</p>
<pre><code>LDC 42
INVOKESTATIC org/python/types/Int.getInt (J)Lorg/python/types/Int;
</code></pre>
<p>On a <a href="https://github.com/pybee/voc/blob/master/tests/bench_datatypes.py">benchmarking test</a>, this results
in about a 15% performance improvement. While this number is synthetic in the sense that the test is written to exploit
this and only this optimization, it is still a verification of performance improvement.</p>
<p>For booleans, since there are only two objects, the savings are even better:</p>
<pre><code>// Without optimization
NEW org/python/types/Bool
DUP
ICONST_0
INVOKESPECIAL org/python/types/Bool.init (Z)V

// With optimization
GETSTATIC org/python/types/Bool.FALSE (Lorg/python/types/Bool;)
</code></pre>
<p>Amazingly, on the benchmark this shows about a 50% improvement.</p>
<h2>Reflections</h2>
<p>So far I am really enjoying my GSoC project. My mentor <a href="https://github.com/freakboy3742">Russ</a> is super knowledgeable
and is great at giving me just enough guidance that I get unstuck, but not telling me I have to implement something a specific way
-- anything goes as long as I can justify it or show a performance improvemnt. That freedom is empowering and refreshing, as
I’m used to adhering to very specific acceptance criteria and usually pre-defined implementation strategies.</p>
<p>Surprisingly, it’s a great complement to my engineering experience and has forced me to work on a few skills that I’ve
never had much reason to hone before, like:</p>
<ul>
<li>
<p>Learning a new codebase without much “meta” information. VOC is a pretty new project and there’s not a lot of documentation about the code, architecture or design documents, etc. I’ve learned that answers always come from reading the code.</p>
</li>
<li>
<p>Consistently making progress without humans around. Usually, on a team of engineers in the same office or at least the same time zone, I’d work at a problem for a few hours or a day maximum before asking for help or someone to talk things out with. But I don’t want to pester Russ (who is in a different time zone) too much, and I never expect a real-time response to a question. Learning how to debug the codebase to move forward is truly the most important skill when onboarding.</p>
</li>
<li>
<p>Old school debugging! Debugging without good tools is a pain. There’s no white-box testing on VOC (yet?), so I’m relying on good ol' print statements (I haven't found tools that equally accommodate Python, Java and Java bytecode). Of the three, Java bytecode is definitely the most ornery, and tinkering with bytecode is a big part of this project.</p>
</li>
</ul>
<p>You can follow the discussion and progression around this work <a href="https://github.com/pybee/voc/pull/825">here</a>, <a href="https://github.com/pybee/voc/pull/830">here</a>, and <a href="https://github.com/pybee/voc/pull/824">here</a>. My github incompetence is woefully obvious here, but I am leaving those giant commit chains there in hope of having lots of improvement to show by the end of the summer.</p>
</div></div></article></div></main></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"VOC Optimization - Primitive Object Preallocation (Google Summer of Code)","date":"2018-06-19T00:30:00.322Z","tags":["python","performance optimization","open source"],"slug":"google-summer-of-code-part-1","content":"\u003cp\u003eI’m about a month into my \u003ca href=\"https://summerofcode.withgoogle.com/\"\u003eGoogle Summer of Code\u003c/a\u003e project with \u003ca href=\"https://pybee.org/\"\u003eBeeWare\u003c/a\u003e, and it’s high time I wrote about the specific library I'm working on and what I’ve been up to.\u003c/p\u003e\n\u003ch2\u003eAbout VOC\u003c/h2\u003e\n\u003cp\u003e\u003ca href=\"https://pybee.org/project/projects/bridges/voc/\"\u003eVOC\u003c/a\u003e is a library that compiles Python code into Java bytecode.\nIt fits into BeeWare’s overarching goal of enabling mobile development in Python because it allows you to run your Python source code on the JVM, and write Python code that interacts with native Android APIs. Essentially, Python source files are parsed into abstract syntax trees and converted into JVM bytecode instructions. Python types and the standard library are implemented in Java (though no Java file is ever created).\nThe result is a bunch of Java class files that can be executed in the JVM.\u003c/p\u003e\n\u003ch2\u003eMy Project\u003c/h2\u003e\n\u003cp\u003eMy project goal is to significantly improve the runtime of VOC-generated bytecode. VOC is a fairly naive compiler,\nand no significant efforts have been made (until now!) to optimize performance, which is good for me because there\nare some pretty low-cost things we can do for a major boost.\nFind my initial project proposal\u003ca href=\"https://github.com/pybee/voc/issues/772%22\"\u003ehere\u003c/a\u003e (though it became outdated about a week into the work).\u003c/p\u003e\n\u003ch2\u003eObject Creation is Expensive\u003c/h2\u003e\n\u003cp\u003eEverything in Python is an Object. This means that even small programs can create tons of Objects, including integers, booleans, and strings. Creating an integer, for example, looks like this in bytecode:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eNEW org/python/types/Int\nDUP\nLDC2_W (Long 42)\nINVOKESPECIAL org/python/types/Int.init (J)V\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eLuckily we can exploit the fact that integers and booleans are immutable objects. Strings are immutable as well, but\nit’s hard to tell which strings are used often enough that they should be cached. Integers, on the other hand, especially\nsmall integers, are used all the time. This optimization idea comes from\n\u003ca href=\"https://github.com/python/cpython/blob/master/Objects/longobject.c#L43\"\u003eCPython\u003c/a\u003e, where integers -5 to 256\ninclusive are pre-allocated, shared and created only once. That’s exactly what we did in VOC, by making the Int constructor\nprivate and checking if we can use a pre-allocated Int before calling the constructor.\u003c/p\u003e\n\u003cp\u003eSo on the bytecode side, we can replace a constructor call with a static method call which is much cheaper:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eLDC 42\nINVOKESTATIC org/python/types/Int.getInt (J)Lorg/python/types/Int;\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eOn a \u003ca href=\"https://github.com/pybee/voc/blob/master/tests/bench_datatypes.py\"\u003ebenchmarking test\u003c/a\u003e, this results\nin about a 15% performance improvement. While this number is synthetic in the sense that the test is written to exploit\nthis and only this optimization, it is still a verification of performance improvement.\u003c/p\u003e\n\u003cp\u003eFor booleans, since there are only two objects, the savings are even better:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e// Without optimization\nNEW org/python/types/Bool\nDUP\nICONST_0\nINVOKESPECIAL org/python/types/Bool.init (Z)V\n\n// With optimization\nGETSTATIC org/python/types/Bool.FALSE (Lorg/python/types/Bool;)\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eAmazingly, on the benchmark this shows about a 50% improvement.\u003c/p\u003e\n\u003ch2\u003eReflections\u003c/h2\u003e\n\u003cp\u003eSo far I am really enjoying my GSoC project. My mentor \u003ca href=\"https://github.com/freakboy3742\"\u003eRuss\u003c/a\u003e is super knowledgeable\nand is great at giving me just enough guidance that I get unstuck, but not telling me I have to implement something a specific way\n-- anything goes as long as I can justify it or show a performance improvemnt. That freedom is empowering and refreshing, as\nI’m used to adhering to very specific acceptance criteria and usually pre-defined implementation strategies.\u003c/p\u003e\n\u003cp\u003eSurprisingly, it’s a great complement to my engineering experience and has forced me to work on a few skills that I’ve\nnever had much reason to hone before, like:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eLearning a new codebase without much “meta” information. VOC is a pretty new project and there’s not a lot of documentation about the code, architecture or design documents, etc. I’ve learned that answers always come from reading the code.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eConsistently making progress without humans around. Usually, on a team of engineers in the same office or at least the same time zone, I’d work at a problem for a few hours or a day maximum before asking for help or someone to talk things out with. But I don’t want to pester Russ (who is in a different time zone) too much, and I never expect a real-time response to a question. Learning how to debug the codebase to move forward is truly the most important skill when onboarding.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eOld school debugging! Debugging without good tools is a pain. There’s no white-box testing on VOC (yet?), so I’m relying on good ol' print statements (I haven't found tools that equally accommodate Python, Java and Java bytecode). Of the three, Java bytecode is definitely the most ornery, and tinkering with bytecode is a big part of this project.\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eYou can follow the discussion and progression around this work \u003ca href=\"https://github.com/pybee/voc/pull/825\"\u003ehere\u003c/a\u003e, \u003ca href=\"https://github.com/pybee/voc/pull/830\"\u003ehere\u003c/a\u003e, and \u003ca href=\"https://github.com/pybee/voc/pull/824\"\u003ehere\u003c/a\u003e. My github incompetence is woefully obvious here, but I am leaving those giant commit chains there in hope of having lots of improvement to show by the end of the summer.\u003c/p\u003e\n"}},"__N_SSG":true},"page":"/writing/[slug]","query":{"slug":"google-summer-of-code-part-1"},"buildId":"4r6jreuI5vp9F2TbxVft0","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>