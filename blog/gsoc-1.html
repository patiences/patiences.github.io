<!DOCTYPE html>
<html>
<head>
  <title>Patience Shyu</title>
  <meta name="description" content="Patience Shyu"/>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css?family=Lobster|Cormorant+Garamond" rel="stylesheet">
  <link href="../css/main.css" rel="stylesheet">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  <link rel="icon" href="../images/favicon-laptop.ico">
</head>
<body>
  <div class="container-fluid">
    <div class="row">
      <div class="col-xs-12">
        <br>
        <h1 class="hello"><a href="/">hi, i'm patience!</a></h1>
        <div class="social">
          <a target="_blank" class="fa fa-github fa-fw fa-2x" href="http://github.com/patiences"></a>
          <a target="_blank" class="fa fa-linkedin fa-fw fa-2x" href="http://linkedin.com/in/patienceshyu"></a>
          <a target="_blank" class="fa fa-medium fa-fw fa-2x" href="https://medium.com/@patiences"></a>
          <a class="fa fa-envelope-o fa-fw fa-2x" href="mailto:patienceshyu@gmail.com"></a>
        </div>
      </div>
    </div>
    <div class="row"><br></div>
    <div class="row">
      <nav class="col-lg-2 navbar">
          <ul class="navigation">
            <li><a href="/about">about<span class="fa fa-chevron-right fa-fw" style="font-size: 0.5em"></span></a></li>
            <li><a href="/blog/listing">blog<span class="fa fa-chevron-right fa-fw" style="font-size: 0.5em"></a></li>
            <li><a href="/resume/PatienceShyu.pdf">resume<span class="fa fa-chevron-right fa-fw" style="font-size: 0.5em"></a></li>
          </ul>
      </nav>
      <div class="blurb col-lg-9 vertical-line">
        <div>
          <p class="small text-muted">June 19th, 2018</p>
          <h1><b>Google Summer of Code 2018, Part 1</b></h1>
          <p>I’m about a month into my <a href="https://summerofcode.withgoogle.com/">Google Summer of Code</a> project with
            <a href="https://pybee.org/">BeeWare</a>, and it’s high time I wrote about the specific library I'm working on and
            what I’ve been up to:</p>
          <h2><b>About VOC</b></h2>
          <p>
            <a href="https://pybee.org/project/projects/bridges/voc/">VOC</a> is a library that compiles Python code into Java
            bytecode. It fits into BeeWare’s overarching goal of enabling mobile development in Python because it allows you to
            run your Python source code on the JVM, and write Python code that interacts with native Android APIs.
            Essentially, Python source files are parsed into abstract syntax trees and converted into JVM bytecode instructions.
            Python types and the standard library are implemented in Java (though no Java file is ever created). The result is
            a bunch of Java class files that can be executed in the JVM.
          </p>
          <h2><b>My Project</b></h2>
          <p>My project goal is to significantly improve the runtime of VOC-generated bytecode. VOC is a fairly naive compiler,
            and no significant efforts have been made (until now!) to optimize performance, which is good for me because there
            are some pretty low-cost things we can do for a major boost. Find my initial project proposal
            <a href="https://github.com/pybee/voc/issues/772">here</a> (though it became outdated about a week into the work).
          </p>
          <h2><b>Object Creation is Expensive</b></h2>
          <p>
            Everything in Python is an Object. This means that even small programs can create tons of Objects, including integers,
            booleans, and strings. Creating an integer, for example, looks like this in bytecode:

            <pre><code>
              NEW org/python/types/Int
              DUP
              LDC2_W (Long 42)
              INVOKESPECIAL org/python/types/Int.init (J)V
            </code></pre>

            Luckily we can exploit the fact that integers and booleans are immutable objects. Strings are immutable as well, but
            it’s hard to tell which strings are used often enough that they should be cached. Integers, on the other hand, especially
            small integers, are used all the time. This optimization idea comes from
            <a href="https://github.com/python/cpython/blob/master/Objects/longobject.c#L43">CPython</a>, where integers -5 to 256
            inclusive are pre-allocated, shared and created only once. That’s exactly what we did in VOC, by making the Int constructor
            private and checking if we can use a pre-allocated Int before calling the constructor.
          </p>
          <p>
            So on the bytecode side, we can replace a constructor call with a static method call which is much cheaper:
            <pre><code>
              LDC 42
              INVOKESTATIC org/python/types/Int.getInt (J)Lorg/python/types/Int;
            </code></pre>
          </p>
          <p>On a <a href="https://github.com/pybee/voc/blob/master/tests/bench_datatypes.py">benchmarking test</a>, this results
            in about a 15% performance improvement. While this number is synthetic in the sense that the test is written to exploit
            this and only this optimization, it is still a verification of performance improvement.
          </p>
          <p>For booleans, since there are only two objects, the savings are even better:
            <pre><code>
              // Without optimization
              NEW org/python/types/Bool
              DUP
              ICONST_0
              INVOKESPECIAL org/python/types/Bool.init (Z)V

              // With optimization
              GETSTATIC org/python/types/Bool.FALSE (Lorg/python/types/Bool;)
            </code></pre>
            Amazingly, on the benchmark this shows about a 50% improvement.
          </p>
          <h2><b>Reflections</b></h2>
          <p>
            So far I am really enjoying my GSoC project. My mentor <a href="https://github.com/freakboy3742">Russ</a> is super knowledgeable
            and is great at giving me just enough guidance that I get unstuck, but not telling me I have to implement something a specific way
            -- anything goes as long as I can justify it or show a performance improvemnt. That freedom is empowering and refreshing, as
            I’m used to adhering to very specific acceptance criteria and usually pre-defined implementation strategies.
          </p>
          <p>
            Surprisingly, it’s a great complement to my engineering experience and has forced me to work on a few skills that I’ve
            never had much reason to hone before, like:
            <ul>
              <li>
              Learning a new codebase without much “meta” information. VOC is a pretty new project and there’s
              not a lot of documentation about the code, architecture or design documents, etc. I’ve learned that answers always
              come from reading the code.
              </li>
              <li>
              Consistently making progress without humans around. Usually, on a team of engineers in the same office or at least the same
              time zone, I’d work at a problem for a few hours or a day maximum before asking for help or someone to talk things out with.
              But I don’t want to pester Russ (who is in a different time zone) too much, and I never expect a real-time response to a question.
              Learning how to debug the codebase to move forward is truly the most important skill when onboarding.
              </li>
              <li>
              Old school debugging! Debugging without good tools is a pain. There’s no white-box testing on VOC (yet?), so I’m relying on
              good ol' print statements (I haven't found tools that equally accommodate Python, Java and Java bytecode). Of the three,
              Java bytecode is definitely the most ornery, and tinkering with bytecode is a big part of this project.
              </li>
            </ul>
          </p>
          <hr>
          <p>
              You can follow the discussion and progression around this work
              <a href="https://github.com/pybee/voc/pull/825">here</a>,
              <a href="https://github.com/pybee/voc/pull/830">here</a>, and
              <a href="https://github.com/pybee/voc/pull/824">here</a>.
              My github incompetence is woefully obvious here, but I am leaving those giant commit chains there in hope of having
              lots of improvement to show by the end of the summer.
          </p>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
